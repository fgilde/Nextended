# Nextended.CodeGen

Compile-time source code generation from various sources including classes, JSON, XML, and Excel files.

## Overview

Nextended.CodeGen is a Roslyn source generator that automatically generates code at compile-time. It supports DTO generation from attributes, class generation from JSON/XML structures, and model generation from Excel spreadsheets.

**Note**: This package is in early testing stage. The API may change in future releases.

## Installation

```bash
dotnet add package Nextended.CodeGen
dotnet add package Nextended.Core
```

## Key Features

### 1. DTO Generation from Attributes

Automatically generate Data Transfer Objects (DTOs) from your domain classes.

```csharp
using Nextended.Core.Attributes;

[AutoGenerateDto(
    ToDtoMethodName = "ToDto",
    ToSourceMethodName = "ToEntity",
    IsComCompatible = true,
    Namespace = "MyApp.Dtos"
)]
public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
    public string Password { get; set; } // Can be excluded in DTO
}
```

Generated DTO:
```csharp
namespace MyApp.Dtos
{
    public class UserDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Email { get; set; }
    }
}
```

### 2. Class Generation from JSON/XML

Generate strongly-typed classes from configuration files or API responses.

```json
// appsettings.json
{
  "Database": {
    "ConnectionString": "Server=localhost;...",
    "MaxPoolSize": 100
  },
  "Api": {
    "BaseUrl": "https://api.example.com",
    "Timeout": 30
  }
}
```

Configuration:
```json
{
  "StructureGenerations": [
    {
      "SourceFile": "/Sources/appsettings.json",
      "RootClassName": "ServerConfiguration",
      "Namespace": "MyApp.Configuration"
    }
  ]
}
```

Generated class:
```csharp
namespace MyApp.Configuration
{
    public class ServerConfiguration
    {
        public Database Database { get; set; }
        public Api Api { get; set; }
    }
    
    public class Database
    {
        public string ConnectionString { get; set; }
        public int MaxPoolSize { get; set; }
    }
    
    public class Api
    {
        public string BaseUrl { get; set; }
        public int Timeout { get; set; }
    }
}
```

### 3. Excel to Class Generation

Generate data classes and static lookup tables from Excel spreadsheets.

```json
{
  "ExcelGenerations": [
    {
      "ModelType": "RecordStruct",
      "SourceFile": "/Sources/countries.xlsx",
      "Namespace": "MyApp.Data",
      "RootClassName": "Country",
      "KeyColumn": "A",
      "HeaderRowIndex": 1,
      "DataStartRowIndex": 2,
      "GenerateModelClass": true,
      "GenerateStaticTable": true,
      "StaticClassName": "Countries",
      "GenerateAllCollection": true
    }
  ]
}
```

## Configuration

### Project Setup

1. Add packages to your `.csproj`:

```xml
<ItemGroup>
  <PackageReference Include="Nextended.CodeGen" Version="9.0.15" />
  <PackageReference Include="Nextended.Core" Version="9.0.15" PrivateAssets="all" GeneratePathProperty="true" />
</ItemGroup>
```

2. Create `CodeGen.config.json`:

```json
{
  "DtoGeneration": {
    "ComIdClassName": "ComGuids",
    "ComIdClassPropertyFormat": "Id{0}",
    "ComIdClassModifier": "Public",
    "OneFilePerClass": true,
    "CreateRegions": true,
    "CreateComments": true,
    "GeneratePartial": true,
    "Namespace": "MyApp.Generated",
    "Suffix": "Dto"
  },
  "StructureGenerations": [
    {
      "SourceFile": "/Sources/appsettings.json",
      "RootClassName": "AppSettings",
      "Namespace": "MyApp.Configuration"
    }
  ]
}
```

3. Add config file to `.csproj`:

```xml
<ItemGroup>
  <AdditionalFiles Include="CodeGen.config.json" />
</ItemGroup>
```

## Usage Examples

### Basic DTO Generation

```csharp
using Nextended.Core.Attributes;

[AutoGenerateDto]
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
    public DateTime CreatedDate { get; set; }
}

// Usage after build
var product = new Product 
{ 
    Id = 1, 
    Name = "Widget", 
    Price = 99.99m 
};

var dto = product.ToDto(); // Generated extension method
var backToEntity = dto.ToEntity(); // Round-trip conversion
```

### Advanced DTO Configuration

```csharp
[AutoGenerateDto(
    Suffix = "Dto",
    Prefix = null,
    ToDtoMethodName = "ToTransferObject",
    ToSourceMethodName = "ToModel",
    Namespace = "MyApp.Dtos",
    IsComCompatible = true,
    GeneratePartial = true
)]
public class Order
{
    public int Id { get; set; }
    public string OrderNumber { get; set; }
    public List<OrderItem> Items { get; set; }
    public Customer Customer { get; set; }
    
    [IgnoreInDto]
    public string InternalNotes { get; set; }
}
```

### Configuration from JSON

**appsettings.json:**
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=MyDb;..."
  },
  "Features": {
    "EnableCache": true,
    "MaxRetries": 3
  }
}
```

**CodeGen.config.json:**
```json
{
  "StructureGenerations": [
    {
      "SourceFile": "/Sources/appsettings.json",
      "RootClassName": "AppConfiguration",
      "Namespace": "MyApp.Config",
      "Ignore": ["Logging.LogLevel.Microsoft"]
    }
  ]
}
```

**Usage:**
```csharp
var config = new AppConfiguration();
var connectionString = config.ConnectionStrings.DefaultConnection;
```

### Excel Data Generation

**Excel file structure:**
| Code | Name | Country | Active |
|------|------|---------|--------|
| US   | United States | USA | Yes |
| UK   | United Kingdom | GBR | Yes |
| CA   | Canada | CAN | Yes |

**Configuration:**
```json
{
  "ExcelGenerations": [
    {
      "SourceFile": "/Sources/locations.xlsx",
      "Namespace": "MyApp.Data",
      "RootClassName": "Location",
      "KeyColumn": "A",
      "StaticClassName": "Locations",
      "GenerateStaticTable": true,
      "ColumnMappings": {
        "Code": "LocationCode",
        "Name": "LocationName"
      }
    }
  ]
}
```

**Generated code:**
```csharp
public record struct Location
{
    public string LocationCode { get; init; }
    public string LocationName { get; init; }
    public string Country { get; init; }
    public string Active { get; init; }
}

public static class Locations
{
    public static Location US => new() 
    { 
        LocationCode = "US", 
        LocationName = "United States",
        Country = "USA",
        Active = "Yes"
    };
    
    public static Location UK => new() 
    { 
        LocationCode = "UK", 
        LocationName = "United Kingdom",
        Country = "GBR",
        Active = "Yes"
    };
    
    public static IReadOnlyList<Location> All { get; } = new[]
    {
        US, UK, CA
    };
}
```

**Usage:**
```csharp
var usLocation = Locations.US;
var allLocations = Locations.All;
```

## Configuration Options

### DtoGeneration Options

| Option | Type | Description |
|--------|------|-------------|
| `Namespace` | string | Target namespace for generated DTOs |
| `Suffix` | string | Suffix for DTO class names (default: "Dto") |
| `Prefix` | string | Prefix for DTO class names |
| `ToDtoMethodName` | string | Name of ToDto extension method |
| `ToSourceMethodName` | string | Name of ToSource extension method |
| `IsComCompatible` | bool | Generate COM-compatible GUIDs |
| `GeneratePartial` | bool | Generate as partial classes |
| `OneFilePerClass` | bool | Create separate file per DTO |
| `CreateRegions` | bool | Add region blocks |
| `CreateComments` | bool | Add XML comments |

### StructureGeneration Options

| Option | Type | Description |
|--------|------|-------------|
| `SourceFile` | string | Path to JSON/XML source file |
| `RootClassName` | string | Name of root generated class |
| `Namespace` | string | Target namespace |
| `Prefix` | string | Prefix for class names |
| `Ignore` | string[] | Paths to ignore in generation |

### ExcelGeneration Options

| Option | Type | Description |
|--------|------|-------------|
| `SourceFile` | string | Path to Excel file |
| `SheetName` | string | Sheet name (null for first sheet) |
| `Namespace` | string | Target namespace |
| `RootClassName` | string | Model class name |
| `StaticClassName` | string | Static lookup class name |
| `KeyColumn` | string | Column for key (e.g., "A") |
| `HeaderRowIndex` | int | Row index for headers |
| `DataStartRowIndex` | int | First data row index |
| `ModelType` | string | "Class", "RecordClass", "RecordStruct" |
| `GenerateModelClass` | bool | Generate model class |
| `GenerateStaticTable` | bool | Generate static lookup |
| `ColumnMappings` | dict | Map column names |

## Best Practices

### 1. Use Meaningful Names

```csharp
[AutoGenerateDto(
    Namespace = "MyApp.Api.Dtos",
    ToDtoMethodName = "ToApiDto",
    ToSourceMethodName = "ToEntity"
)]
public class User { }
```

### 2. Organize Generated Code

```json
{
  "DtoGeneration": {
    "Namespace": "MyApp.Generated.Dtos",
    "OutputPath": "./Generated/Dtos/",
    "OneFilePerClass": true
  }
}
```

### 3. Version Control Generated Files

Add to `.gitignore` if you regenerate on build, or commit them if you want to review changes.

### 4. Use Partial Classes for Customization

Generated as partial classes allow you to extend:

```csharp
// Generated
public partial class UserDto
{
    public int Id { get; set; }
    public string Name { get; set; }
}

// Your custom code
public partial class UserDto
{
    public string DisplayName => $"User: {Name}";
}
```

## Troubleshooting

### Generated Code Not Appearing

1. Ensure `CodeGen.config.json` is marked as `AdditionalFiles`
2. Clean and rebuild: `dotnet clean && dotnet build`
3. Check build output for generator messages
4. Verify source generators are enabled in IDE

### Build Errors After Generation

1. Check namespace conflicts
2. Verify property types are valid
3. Ensure all dependencies are installed

## Supported Frameworks

- .NET Standard 2.0 (Generator)
- .NET 8.0+  (Generated code)

## Dependencies

- Roslyn APIs for source generation
- `Nextended.Core` for attributes

## Related Projects

- [Nextended.Core](core.md) - Provides attributes and base functionality
- [Nextended.AutoDto](autodto.md) - DTO generation support

## Sample Project

See the [CodeGenSample](https://github.com/fgilde/Nextended/tree/main/CodeGenSample) project for complete examples.

## Links

- [NuGet Package](https://www.nuget.org/packages/Nextended.CodeGen/)
- [Source Code](https://github.com/fgilde/Nextended/tree/main/Nextended.CodeGen)
- [Official README](https://github.com/fgilde/Nextended/blob/main/Nextended.CodeGen/README.md)
- [Report Issues](https://github.com/fgilde/Nextended/issues)
