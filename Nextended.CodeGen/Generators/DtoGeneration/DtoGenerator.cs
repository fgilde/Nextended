using Microsoft.CodeAnalysis;
using Nextended.CodeGen.Attributes;
using Nextended.CodeGen.Config;
using Nextended.CodeGen.Helper;

namespace Nextended.CodeGen.Generators.DtoGeneration;

public class DtoGenerator
{
    private readonly DtoGenerationConfig _config;

    public DtoGenerator(DtoGenerationConfig config)
    {
        _config = config;
    }

    public void Execute(GeneratorExecutionContext context)
    {
        var compilation = context.Compilation;
        var symbols = DtoGenerationSymbols.Collect(compilation);
        if (symbols.AutoGenerateDto == null)
            return;

        var types = symbols.FindTypesWithAttribute(compilation);
        var generator = new DtoCodeGenerator(_config, symbols);

        if (_config.OneFilePerClass)
        {
            foreach (var type in types)
            {
                var file = generator.GenerateAllForType(type, types);
                context.AddSource(file.FileName, file.Content);
            }

            if (generator.HasGuids)
            {
                var comIdFile = generator.GenerateComIdFile(types);
                context.AddSource(comIdFile.FileName, comIdFile.Content);
            }
        }
        else
        {
            // Gruppiere alle Typen nach Namespace (optional, falls du versch. Namespaces hast)
            var typesByNs = types.GroupBy(t => t.GetAttributeInstance<AutoGenerateDtoAttribute>(symbols.AutoGenerateDto)?.Namespace ?? _config.Namespace);
            foreach (var group in typesByNs)
            {
                var ns = group.Key;
                var comTypeDict = types.ToDictionary(t => t.ToDisplayString(), t => t);
                var file = generator.GenerateNamespaceFile(ns, group, comTypeDict);
                context.AddSource(file.FileName, file.Content);
            }
        }

        // Mapping-Extensions ggf. als eigene Datei
        var mappingFile = generator.GenerateMappingExtensions(types.ToList());
        if (mappingFile != null)
            context.AddSource(mappingFile.FileName, mappingFile.Content);
    }
}
